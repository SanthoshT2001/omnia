# Copyright 2024 Intel Corporation.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Check if accelerator is present on node
  ansible.builtin.include_tasks: verify_has_accelerators.yml

- name: Install drivers on Gaudi nodes
  when: node_has_accelerator
  block:
    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Check if kernel supported
      ansible.builtin.fail:
        msg: "Kernel not supported"
      when: ansible_kernel is version('5.4.0', '<')

    - name: Base dependencies
      ansible.builtin.apt:
        name: "{{ intel_apt_base_packages | list }}"
        state: latest  # noqa package-latest
        update_cache: true

    - name: Update apt and install habanalabs dependencies
      ansible.builtin.apt:
        name: "{{ intel_habana_packages | list }}"
        update_cache: true

    - name: Get Secure Boot Status
      ansible.builtin.shell: |
        set -o pipefail
        mokutil --sb-state | grep SecureBoot
      register: sb_out
      failed_when: (sb_out.stdout.find('enabled') != -1)
      changed_when: false
      args:
        executable: /bin/bash

    - name: Add Gaudi kernel modules
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop: "{{ intel_gaudi_kernel_module_to_load }}"

    - name: Import playbook to set performance profile on nodes 
      ansible.builtin.import_playbook: "{{ performance_profile_path }}" 
